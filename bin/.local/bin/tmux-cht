#!/usr/bin/env bash
file_path="$HOME/.cache/cheat-sheets"
local_cheatsheets="$HOME/.config/cheatsheets"
obsidian_cheatsheets="$HOME/Documents/Obsidian"

# If the cache is older than 1 day, update it
if [[ ! -f $file_path ]] || [[ $(find $file_path -mtime +1 -print) ]]; then
    echo "Updating cheat sheets..."
    curl https://cheat.sh/:list > $file_path
else
    echo "Using cached cheat sheets..."
fi
#
# Function to recursively get files from a directory
get_files_recursive() {
    local dir="$1"
    local files=""
    shopt -s nullglob
    for file in "$dir"/*; do
        if [[ -f $file ]]; then
            files+="$(basename "$file")\n"
        elif [[ -d $file ]]; then
            files+=$(get_files_recursive "$file")
        fi
    done
    echo -e "$files"
}

# Get basenames of files in the additional lines directory
additional_lines_content=""
additional_lines_content+=$(get_files_recursive "$local_cheatsheets")
additional_lines_content+=$(get_files_recursive "$obsidian_cheatsheets")

# Concatenate additional lines with file contents
file_contents=$(cat "$file_path")
content_with_additional_lines=$(printf "%s\n%s" "$additional_lines_content" "$file_contents")

selected=$(echo -e "$content_with_additional_lines" | fzf)

if [[ -z $selected ]]; then
    exit 0
fi

if grep -qs $selected $additional_lines_content; then
    selected=""
    exit 0
fi

if echo -e "$additional_lines_content" | grep -q -E "(^|\n)$selected($|\n)"; then
    # If the selected line is in the additional lines directory, cat it
    tmux new-window "nvim \"$local_cheatsheets/$selected\""
    exit 0
fi

selected_name="$selected"
# Spawn it in a window, since I want to be able to quit it easily and go back to my previous window
tmux new-window "curl \"https://cheat.sh/$selected\" | less -r"
