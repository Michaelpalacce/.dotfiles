#!/usr/bin/env zsh

# Dependencies: fzf, tmux

# This will search for folders that have `.git` folder in them and show them
selected=$(find ~/projects ~/projects/clients ~/.dotfiles -mindepth 1 -maxdepth 3 -type d -name ".git" -exec dirname {} \;  2>/dev/null | fzf)

if [[ -z $selected ]]; then
    exit 0
fi

selected_name=$(basename "$selected" | tr . _)
tmux_running=$(pgrep tmux)

unameOut="$(uname -s)"
case "${unameOut}" in
    Linux*)     machine=Linux;;
    Darwin*)    machine=Mac;;
    *)          machine="UNKNOWN:${unameOut}"
esac

# Create a new session with the chosen file
# Create a new window in the session too, so we can go to it if we need to run a command
if ! tmux has-session -t=$selected_name 2> /dev/null; then

    tmux new-session -ds $selected_name -c $selected "zsh -i -c '$1'"

    tmux split-window -v -t $selected_name -p 10 -c $selected
    tmux switch-client -t $selected_name:0.0
    # tmux send-keys -t $selected_name:0.1 'git pull' Enter
    # This will do a git pull in a second pane and it will quit, so you won't probably see it
    tmux new-window -d -t $selected_name -c $selected 'git pull'
fi

if [[ -z $TMUX ]]; then
    # We are outside of TMUX
    tmux attach -t $selected_name
else
    # We are inside of TMUX
    tmux switch-client -t $selected_name
fi
